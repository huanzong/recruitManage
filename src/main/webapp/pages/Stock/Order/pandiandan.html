<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>流程页</title>
    <link href="/pages/css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="/custom/uimaker/easyui.css">
    <link href="/pages/css/process.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="/custom/uimaker/icon.css">
</head>
<body>
<div class="title_order">盘点</div>
<form method="post" id="wu-form-2">
    <div style="padding: 0px 15px 10px 15px">
        <table class="kv-table">
            <tr>
                <input type="hidden" name="id" value="0"/>
                <input type="hidden" name="type" value="99">
            </tr>
            <tr>
                <td align="right" class="">仓库名称：</td>
                <td><input type="text" name="store_id" class="easyui-combobox inputlist combobox" editable="false"
                           required="required" data-options="valueField:'id',textField:'name',url:'/Store/storelist'">
                </td>
                <td align="right" class="">单据日期：</td>
                <td><input type="text" name="date" class="easyui-datebox  inputlist" editable="false" required="true">
                </td>
            </tr>
            <tr>
                <td align="right" class="">备注：</td>
                <td colspan="3"><input type="text" name="comments" class="easyui-validatebox comments inputlist"
                                       required="true"></td>
            </tr>
            <tr>
                <td align="right" class="">书籍：</td>
                <td><input class="easyui-combobox drugsid" name="drugs_id"
                           data-options="valueField:'id',textField:'name',url:'/Stock/drugslist'"></td>
                <td align="right" class="">旧数量：</td>
                <td><input type="text" name="oldcount" class="easyui-validatebox  inputlist noborder" required="true"
                           editable="false"></td>
            </tr>
            <tr>
                <td align="right" class="">数量：</td>
                <td><input type="text" name="count" class="easyui-validatebox  inputlist" required="true"></td>
                <td></td>
                <td><a href="#" class="easyui-linkbutton easyui-linkbutton1" onclick="adda();"
                       style="line-height: 24px;height: 24px;">添加</a></td>
            </tr>
            <tr>
                <td colspan="4">
                    <table class="orderdetail" style="width:100%;height: 100px" data-options="
                              singleSelect:true,
                              autoRowHeight:false,
                              fitColumns:true,
                              striped:true,
                              remoteSort:true,
                              checkOnSelect:false,
                              selectOnCheck:false,
                              pageSize:10">
                    </table>
                </td>
            </tr>
        </table>
    </div>
</form>

<script type="text/javascript" src="/custom/easyui-lang-zh_CN.js"></script>
<script type="text/javascript">


    var orderdetail = [];
    if (alldata != null) {
        $('#dd form').form('load', alldata);
        $.ajax({
            url: "/Orderdetail/index?where= where order_details.order_id=" + $('#tt').datagrid('getSelected').id,
            success: function (data) {
                if (data) {
                    $(".orderdetail").datagrid({
                        data: data.rows
                    })
                    orderdetail = data.rows;
                }
            }
        });
    }
    $("[name=drugs_id]").combobox({
        onSelect: function (rec) {
            if ($("[name=store_id]").val() != "") {
                var store_id = $("[name=store_id]").val();
                $.ajax({
                    url: '/Stock/getStock',
                    type: "post",
                    dataType: "json",
                    data: {
                        drugs_id: rec.id,
                        store_id: store_id,
                    },
                    success: function (data) {
                        $("[name=oldcount]").val(data.count);
                    }
                });
            }
        }
    })
    $("[name=store_id]").combobox({
        onSelect: function (rec) {
            if ($("[name=drugs_id]").val() != "") {
                var drugs_id = $("[name=drugs_id]").val();
                $.ajax({
                    url: '/Stock/getStock',
                    type: "post",
                    dataType: "json",
                    data: {
                        drugs_id: drugs_id,
                        store_id: rec.id,
                    },
                    success: function (data) {
                        $("[name=oldcount]").val(data.count);
                    }
                });
            }
        }
    })
    //设置tab高度
    $('.easyui-tabs1').tabs({
        tabHeight: 36
    });

    //添加单据详情
    function adda() {
        var drugs_id = $("[name=drugs_id]").val();
        var count = $("[name=count]").val();
        var oldcount = $("[name=oldcount]").val();
        var price = $("[name=price]").val();
        if (drugs_id == 0 || count == 0 || price == 0) return;
        $.ajax({
            url: '/Orderdetail/Assembled',
            type: "post",
            dataType: "json",
            data: {
                drugs_id: drugs_id,
                price: price,
                count: count,
                oldcount: oldcount
            },
            success: function (data) {
                orderdetail.push(data);
                $('.orderdetail').datagrid({
                    data: orderdetail
                });
                resum();
            },
            error: function (XMLHttpRequest, textStatus, errorThrown) {
                alert("textStatus = " + textStatus + ", XMLHttpRequest.status = " + XMLHttpRequest.status + ", XMLHttpRequest.readyState = " + XMLHttpRequest.readyState);
            }
        });

    }

    //删除方法
    function del(target) {
        $.messager.confirm('提示', '确定删除？', function (r) {
            if (r) {
                $('.orderdetail').datagrid('deleteRow', getRowIndex(target));
                resum();
            }
        });
    }

    function getRowIndex(target) {
        var tr = $(target).closest('tr.datagrid-row');
        return parseInt(tr.attr('datagrid-row-index'));
    }

    //        计算金额方法
    function resum() {
        var sum = 0;
        var rows = $('.orderdetail').datagrid("getRows");
        for (var i = 0; i < rows.length; i++) {
            sum = sum + rows[i].price * rows[i].count;
        }
        $('[name=amount]').val(sum);
    }

    //单据详情信息初始化
    $(function () {
        $('.orderdetail').datagrid({
            url: "",
            columns: [[
                {field: 'dname', title: '商品名称', width: 80, sortable: true},
                {field: 'oldcount', title: '旧数量', width: 80, sortable: true},
                {field: 'count', title: '盘点数量', width: 80, sortable: true},
                {field: 'comments', title: '明细备注', width: 80, sortable: true},
                {
                    field: 'opt', title: '操作', width: 60, align: 'center',
                    formatter: function (value, rec) {
                        var btn = "<a class='easyui-linkbutton' iconCls='icon-add' href='#' onclick='del(this)'>删除</a>";
                        return btn;
                    }
                }
            ]]
        });
    })


</script>
<style>
    tr {
        height: 30px;
    }

    tr > td:nth-child(odd) {
        color: #999;
        padding-right: 6px;
        padding-bottom: 5px;
        padding-left: 6px;
    }

    .inputlist {
        margin-bottom: 8px;
        width: 150px;
        height: 24px;
    }

    .multiple {
        height: 48px;
    }

    .combobox {
        height: 26px;
        margin-left: 4px
    }

    .comments {
        width: 413px;
    }

    .noborder {
        border: 0px;
        background-color: rgba(255, 255, 255, 0);
    }

    .title_order {
        text-align: center;
        font-size: 20px;
        padding-top: 20px;
        font-weight: bold;
    }
</style>
</body>
</html>
